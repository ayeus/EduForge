<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Course - LMS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='create_course.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="brand">EduForge</div>
        <div class="nav-links">
            <a href="{{ url_for('instructor_dashboard') }}" class="nav-link">Home</a>
            <a href="#" class="nav-link">About</a>
            <a href="#" class="nav-link">Community</a>
        </div>
        <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    </nav>

    <!-- Course Creation Form -->
    <div class="container">
        <h1>Create a New Course</h1>
        <form method="POST" action="{{ url_for('create_course') }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="course_name">Course Name:</label>
                <input type="text" id="course_name" name="course_name" required>
            </div>
            <div class="form-group">
                <label for="description">Course Description:</label>
                <textarea id="description" name="description" required></textarea>
            </div>

            <h3>Add Lessons</h3>
            <div id="lessons">
                <div class="lesson">
                    <div class="form-group">
                        <label for="lesson_name_1">Lesson Name:</label>
                        <input type="text" id="lesson_name_1" name="lesson_name_1" required>
                    </div>
                    <div class="form-group">
                        <label for="lesson_content_1">Lesson Content:</label>
                        <textarea id="lesson_content_1" name="lesson_content_1" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Record Video:</label>
                        <video id="preview_1" controls style="width: 100%;"></video>
                        <button type="button" id="startRecording_1">Start Recording</button>
                        <button type="button" id="stopRecording_1" disabled>Stop Recording</button>
                        <input type="hidden" id="video_1" name="video_1">
                    </div>
                    <div class="form-group">
                        <label>Or Upload Video:</label>
                        <input type="file" id="upload_video_1" name="upload_video_1" accept="video/*">
                    </div>
                </div>
            </div>

            <button type="button" id="add_lesson" class="btn">Add Another Lesson</button>
            <button type="submit" class="btn">Create Course</button>
        </form>
    </div>

    <script>
        // JavaScript to dynamically add more lesson fields
        let lessonCount = 1;

        document.getElementById("add_lesson").addEventListener("click", function () {
            lessonCount++;
            const lessonsDiv = document.getElementById("lessons");

            const newLesson = document.createElement("div");
            newLesson.className = "lesson";
            newLesson.innerHTML = `
                <div class="form-group">
                    <label for="lesson_name_${lessonCount}">Lesson Name:</label>
                    <input type="text" id="lesson_name_${lessonCount}" name="lesson_name_${lessonCount}" required>
                </div>
                <div class="form-group">
                    <label for="lesson_content_${lessonCount}">Lesson Content:</label>
                    <textarea id="lesson_content_${lessonCount}" name="lesson_content_${lessonCount}" required></textarea>
                </div>
                <div class="form-group">
                    <label>Record Video:</label>
                    <video id="preview_${lessonCount}" controls style="width: 100%;"></video>
                    <button type="button" id="startRecording_${lessonCount}">Start Recording</button>
                    <button type="button" id="stopRecording_${lessonCount}" disabled>Stop Recording</button>
                    <input type="hidden" id="video_${lessonCount}" name="video_${lessonCount}">
                </div>
                <div class="form-group">
                    <label>Or Upload Video:</label>
                    <input type="file" id="upload_video_${lessonCount}" name="upload_video_${lessonCount}" accept="video/*">
                </div>
            `;

            lessonsDiv.appendChild(newLesson);
            setupRecording(lessonCount);
        });

        // Function to set up video recording
        function setupRecording(lessonId) {
            const preview = document.getElementById(`preview_${lessonId}`);
            const startButton = document.getElementById(`startRecording_${lessonId}`);
            const stopButton = document.getElementById(`stopRecording_${lessonId}`);
            const videoInput = document.getElementById(`video_${lessonId}`);

            let recorder;
            let stream;

            startButton.addEventListener("click", async () => {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                preview.srcObject = stream;
                preview.play();

                recorder = new RecordRTC(stream, {
                    type: "video",
                    mimeType: "video/webm",
                });

                recorder.startRecording();
                startButton.disabled = true;
                stopButton.disabled = false;
            });

            stopButton.addEventListener("click", () => {
                recorder.stopRecording(() => {
                    const blob = recorder.getBlob();

                    // Create a File object from the Blob
                    const file = new File([blob], `lesson_${lessonId}.webm`, { type: "video/webm" });

                    // Add the file to the file input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    videoInput.files = dataTransfer.files;

                    // Stop the stream
                    stream.getTracks().forEach(track => track.stop());
                    startButton.disabled = false;
                    stopButton.disabled = true;
                });
            });
        }

        // Set up recording for the first lesson
        setupRecording(1);
    </script>
</body>
</html>